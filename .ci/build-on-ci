#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

repo_dir="$(readlink -f "$(dirname "${0}")/..")"
cd $repo_dir

apk add --no-cache -X http://dl-cdn.alpinelinux.org/alpine/edge/testing hub
apk add make

# set up component-cli
TEMP_DIR="$(mktemp -d)"
FILE_NAME="componentcli-linux-amd64"
OUT_FILE="${TEMP_DIR}/${FILE_NAME}.gz"
curl -L https://github.com/gardener/component-cli/releases/latest/download/componentcli-linux-amd64.gz -o "${OUT_FILE}"
gzip -d "${OUT_FILE}"
chmod +x "${TEMP_DIR}/${FILE_NAME}"
mv "${TEMP_DIR}/${FILE_NAME}" /usr/bin/component-cli
# as of time of writing, we have a "replacement" component-cli in place in the job-image that takes precedence since it is
# found first in $PATH. Therefore we have to update $PATH as well here
export PATH="/usr/bin:${PATH}"

"${repo_dir}/.ci/prepare_gituser.py"
chmod 600 "${HOME}/.ssh/id_rsa"
username=$(cat ${HOME}/github_user)
user_token=$(cat ${HOME}/github_token)
user_email=$(cat ${HOME}/github_email)

git config --global user.email "${username}"
git config --global user.name "${user_email}"

"${repo_dir}/.ci/write_docker_cfg.py"

# final setup for buildx
docker buildx create --use

BUILD_CD="yes" GITHUB_USER="${username}" GITHUB_TOKEN="${user_token}" "${repo_dir}/.ci/check-and-release"
